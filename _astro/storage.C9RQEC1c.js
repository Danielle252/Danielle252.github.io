const b="astroPwaDB";const a="userStats",w=()=>new Promise((r,e)=>{const t=indexedDB.open(b,1);t.onerror=o=>{console.error("IndexedDB error:",o.target.error),e("Error opening database")},t.onupgradeneeded=o=>{const s=o.target.result;if(!s.objectStoreNames.contains(a)){const n=s.createObjectStore(a,{keyPath:"id"});n.createIndex("id","id",{unique:!0}),n.transaction.oncomplete=()=>{s.transaction(a,"readwrite").objectStore(a).add({id:"user",xp:0})}}},t.onsuccess=o=>{const s=o.target.result;r(s)}}),f=async r=>{try{const e=await w();return new Promise((t,o)=>{const i=e.transaction(a,"readwrite").objectStore(a).put(r);i.onsuccess=()=>{t(!0)},i.onerror=u=>{console.error("Error saving data:",u.target.error),o("Error saving data")}})}catch(e){return console.error("Could not save data:",e),!1}},y=async(r="user")=>{try{const e=await w();return new Promise((t,o)=>{const i=e.transaction(a,"readonly").objectStore(a).get(r);i.onsuccess=u=>{u.target.result?t(u.target.result):t({id:r,xp:0})},i.onerror=u=>{console.error("Error getting data:",u.target.error),o("Error getting data")}})}catch(e){return console.error("Could not get data:",e),{id:"user",xp:0}}},F=async()=>{try{const r=await w();return new Promise((e,t)=>{const s=r.transaction(a,"readwrite").objectStore(a),n=s.clear();n.onsuccess=()=>{s.add({id:"user",xp:0}),e(!0)},n.onerror=i=>{console.error("Error clearing data:",i.target.error),t("Error clearing data")}})}catch(r){return console.error("Could not clear data:",r),!1}};let c=null;const g=()=>"showDirectoryPicker"in window,p=async()=>{if(!g())throw new Error("File System Access API is not supported in this browser");try{return c=await window.showDirectoryPicker({mode:"readwrite",startIn:"documents"}),!0}catch(r){throw console.error("Error accessing file system:",r),r}},m=async()=>{if(!c)return!1;try{const r={mode:"readwrite"},e=await c.queryPermission(r);return e==="granted"?!0:e!=="denied"?await c.requestPermission(r)==="granted":!1}catch(r){return console.error("Error verifying permission:",r),!1}},P=async(r,e)=>{if(!c)throw new Error("No directory access. Please request file system access first.");try{if(!await m())throw new Error("Permission to write to the directory was denied.");const s=await(await c.getFileHandle(r,{create:!0})).createWritable(),n=JSON.stringify(e,null,2);return await s.write(n),await s.close(),!0}catch(t){throw console.error("Error saving to file:",t),t}},D=async r=>{if(!c)throw new Error("No directory access. Please request file system access first.");try{if(!await m())throw new Error("Permission to read from the directory was denied.");try{const s=await(await(await c.getFileHandle(r)).getFile()).text();return JSON.parse(s)}catch(t){if(t.name==="NotFoundError")return null;throw t}}catch(e){throw console.error("Error reading from file:",e),e}},h=async r=>{try{return await P("user-stats.json",r)}catch(e){return console.error("Error saving user stats:",e),!1}},x=async()=>{try{return await D("user-stats.json")||{id:"user",xp:0}}catch(r){return console.error("Error reading user stats:",r),{id:"user",xp:0}}};let d=!1,l=!1;const v=async()=>{try{return await w(),d=g(),{indexedDBAvailable:!0,fileSystemAvailable:d}}catch(r){return console.error("Error initializing storage:",r),{indexedDBAvailable:!1,fileSystemAvailable:!1}}},j=async()=>{if(!d)return!1;try{if(l=await p(),l){const r=await y();await h(r)}return l}catch(r){return console.error("Error requesting file system permission:",r),l=!1,!1}},S=async()=>{try{if(d&&l)try{const r=await x();return await f(r),r}catch(r){console.warn("Could not read from file system, falling back to IndexedDB:",r)}return await y()}catch(r){return console.error("Error getting user data:",r),{id:"user",xp:0}}},E=async r=>{try{return await f(r),d&&l&&await h(r),!0}catch(e){return console.error("Error saving user data:",e),!1}},q=async r=>{try{const e=await S();return e.xp+=r,await E(e)}catch(e){return console.error("Error updating XP:",e),!1}},B=()=>({indexedDBAvailable:!0,fileSystemAvailable:d,fileSystemPermission:l}),A=Object.freeze(Object.defineProperty({__proto__:null,getStorageStatus:B,getUserData:S,initStorage:v,requestFileSystemPermission:j,saveUserData:E,updateXP:q},Symbol.toStringTag,{value:"Module"}));export{B as a,F as c,S as g,v as i,j as r,A as s,q as u};
